{#
  Template  : leaf_l2vpn.j2
  Transform : leaf-l2vpn-config
  Query     : leaf_l2vpn
  Output    : SR Linux gNMI-ready hierarchical JSON (YANG-modeled)
              Push with:
                gnmic -a <mgmt-ip> set --update-path / \
                      --update-file <artifact> --encoding JSON_IETF
              Or via SR Linux JSON-RPC / Ansible nokia.grpc collection.
  Note      : Server-facing access interfaces (ethernet-X/Y.VLAN) are
              device-specific and rendered by a separate per-device transform.
#}

{# ── Resolve inputs ───────────────────────────────────────────────────── #}
{% set device = data.DcoDevice.edges[0].node %}

{# Sort VLANs by vlan_id ascending → stable irb0 subinterface index #}
{% set vlans = data.DcoVLAN.edges | map(attribute='node') | list | sort(attribute='vlan_id.value') | list %}
{% set vrfs   = data.DcoVRF.edges  | map(attribute='node') | list | sort(attribute='name.value')   | list %}

{# ── Guard: only render for leaf nodes ───────────────────────────────── #}
{% if device.role.value != 'leaf' %}
{}
{% else %}
{
  "tunnel-interface": [
    {
      "name": "vxlan0",
      "vxlan-interface": [
{% for vlan in vlans %}
        {
          "index": {{ vlan.evi.value }},
          "type": "bridged",
          "ingress": { "vni": {{ vlan.vni.value }} },
          "egress": { "source-ip": "use-system-ipv4-address" }
        }{% if not loop.last or vrfs %},{% endif %}

{% endfor %}
{% for vrf in vrfs %}
        {
          "index": {{ vrf.l3_evi.value }},
          "type": "routed",
          "ingress": { "vni": {{ vrf.l3_vni.value }} },
          "egress": { "source-ip": "use-system-ipv4-address" }
        }{% if not loop.last %},{% endif %}

{% endfor %}
      ]
    }
  ],

  "interface": [
    {
      "name": "irb0",
      "subinterface": [
{% for vlan in vlans %}
{% set irb_idx = loop.index0 %}
        {
          "index": {{ irb_idx }},
          "ip-mtu": 1500,
          "ipv4": {
            "admin-state": "enable",
            "address": [
              {
                "ip-prefix": "{{ vlan.anycast_gw.value }}",
                "anycast-gw": true,
                "primary": {}
              }
            ],
            "arp": {
              "timeout": 250,
              "proxy-arp": true,
              "evpn": {
                "advertise": [
                  { "route-type": "dynamic" }
                ]
              }
            }
          },
          "anycast-gw": {
            "virtual-router-id": 1
          }
        }{% if not loop.last %},{% endif %}

{% endfor %}
      ]
    }
  ],

  "network-instance": [
{% for vlan in vlans %}
{% set irb_idx = loop.index0 %}
    {
      "name": "macvrf-v{{ vlan.vlan_id.value }}",
      "type": "mac-vrf",
      "admin-state": "enable",
      "description": "macvrf-v{{ vlan.vlan_id.value }}",
      "interface": [
        { "name": "irb0.{{ irb_idx }}" }
      ],
      "vxlan-interface": [
        { "name": "vxlan0.{{ vlan.evi.value }}" }
      ],
      "protocols": {
        "bgp-evpn": {
          "bgp-instance": [
            {
              "id": 1,
              "admin-state": "enable",
              "vxlan-interface": "vxlan0.{{ vlan.evi.value }}",
              "evi": {{ vlan.evi.value }},
              "ecmp": 8,
              "routes": {
                "bridge-table": {
                  "mac-ip": {
                    "advertise-arp-nd-only-with-mac-table-entry": true
                  }
                }
              }
            }
          ]
        },
        "bgp-vpn": {
          "bgp-instance": [
            {
              "id": 1,
              "route-target": {
                "export-rt": "{{ vlan.route_target.value }}",
                "import-rt": "{{ vlan.route_target.value }}"
              }
            }
          ]
        }
      },
      "bridge-table": {
        "mac-learning": {
          "admin-state": "enable",
          "aging": {
            "admin-state": "enable",
            "age-time": 300
          }
        },
        "mac-duplication": {
          "admin-state": "enable",
          "monitoring-window": 3,
          "num-moves": 5,
          "hold-down-time": 9,
          "action": "stop-learning"
        }
      }
    },
{% endfor %}
{% for vrf in vrfs %}
{# Collect IRB indices belonging to this VRF #}
{% set ns = namespace(vrf_irbs=[]) %}
{% for i in range(vlans | length) %}
{% if vlans[i].vrf.node.name.value == vrf.name.value %}
{% set ns.vrf_irbs = ns.vrf_irbs + [i] %}
{% endif %}
{% endfor %}
    {
      "name": "{{ vrf.name.value }}",
      "type": "ip-vrf",
      "admin-state": "enable",
      "description": "{{ vrf.name.value }}",
      "interface": [
{% for irb_idx in ns.vrf_irbs %}
        { "name": "irb0.{{ irb_idx }}" }{% if not loop.last %},{% endif %}

{% endfor %}
      ],
      "vxlan-interface": [
        { "name": "vxlan0.{{ vrf.l3_evi.value }}" }
      ],
      "protocols": {
        "bgp-evpn": {
          "bgp-instance": [
            {
              "id": 1,
              "admin-state": "enable",
              "vxlan-interface": "vxlan0.{{ vrf.l3_evi.value }}",
              "evi": {{ vrf.l3_evi.value }},
              "ecmp": 8,
              "routes": {
                "route-table": {
                  "mac-ip": {
                    "advertise-gateway-mac": true
                  }
                }
              }
            }
          ]
        },
        "bgp-vpn": {
          "bgp-instance": [
            {
              "id": 1,
              "route-target": {
                "export-rt": "{{ vrf.route_target.value }}",
                "import-rt": "{{ vrf.route_target.value }}"
              }
            }
          ]
        }
      }
    }{% if not loop.last %},{% endif %}

{% endfor %}
  ]
}
{% endif %}{# end leaf guard #}
