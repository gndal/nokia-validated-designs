{#
  Template  : leaf_l2vpn.j2
  Transform : leaf-l2vpn-config
  Query     : leaf_l2vpn
  Purpose   : Generate SR Linux L2VPN configuration for a leaf node.
              Covers: tunnel-interface vxlan0, interface irb0 sub-interfaces,
              mac-vrf network instances, and ip-vrf network instances.
  Note      : Server-facing access interfaces (ethernet-X/Y.VLAN) are
              device-specific and rendered by a separate per-device transform.
#}

{# ── Resolve inputs ───────────────────────────────────────────────────── #}
{% set device = DcoDevice.edges[0].node %}

{# Sort VLANs by vlan_id ascending → stable irb0 subinterface index #}
{% set vlans = DcoVLAN.edges | map(attribute='node') | sort(attribute='vlan_id.value') | list %}
{% set vrfs   = DcoVRF.edges  | map(attribute='node') | sort(attribute='name.value')   | list %}

{# ── Guard: only render for leaf nodes ───────────────────────────────── #}
{% if device.role.value != 'leaf' %}
# Nothing to render – {{ device.hostname.value }} is a {{ device.role.value }}, not a leaf.
{% else %}

# ============================================================
# L2VPN configuration for {{ device.hostname.value }}
# System IP : {{ device.system_ip.value }}   ASN : {{ device.asn.value }}
# Generated by Infrahub transform: leaf-l2vpn-config
# ============================================================

# ── tunnel-interface vxlan0 (L2 bridged – one per mac-vrf) ───────────
{% for vlan in vlans %}
set / tunnel-interface vxlan0 vxlan-interface {{ vlan.evi.value }} type bridged
set / tunnel-interface vxlan0 vxlan-interface {{ vlan.evi.value }} ingress vni {{ vlan.vni.value }}
set / tunnel-interface vxlan0 vxlan-interface {{ vlan.evi.value }} egress source-ip use-system-ipv4-address
{% endfor %}

# ── tunnel-interface vxlan0 (L3 routed – one per ip-vrf) ─────────────
{% for vrf in vrfs %}
set / tunnel-interface vxlan0 vxlan-interface {{ vrf.l3_evi.value }} type routed
set / tunnel-interface vxlan0 vxlan-interface {{ vrf.l3_evi.value }} ingress vni {{ vrf.l3_vni.value }}
set / tunnel-interface vxlan0 vxlan-interface {{ vrf.l3_evi.value }} egress source-ip use-system-ipv4-address
{% endfor %}

# ── interface irb0 subinterfaces (anycast-gw per VLAN) ───────────────
{% for vlan in vlans %}
{% set irb_idx = loop.index0 %}
set / interface irb0 subinterface {{ irb_idx }} ip-mtu 1500
set / interface irb0 subinterface {{ irb_idx }} ipv4 admin-state enable
set / interface irb0 subinterface {{ irb_idx }} ipv4 address {{ vlan.anycast_gw.value }} anycast-gw true
set / interface irb0 subinterface {{ irb_idx }} ipv4 address {{ vlan.anycast_gw.value }} primary
set / interface irb0 subinterface {{ irb_idx }} ipv4 arp timeout 250
set / interface irb0 subinterface {{ irb_idx }} ipv4 arp proxy-arp true
set / interface irb0 subinterface {{ irb_idx }} ipv4 arp evpn advertise dynamic
set / interface irb0 subinterface {{ irb_idx }} anycast-gw virtual-router-id 1
{% endfor %}

# ── mac-vrf network instances (L2 EVPN, one per VLAN) ────────────────
{% for vlan in vlans %}
{% set irb_idx = loop.index0 %}
set / network-instance macvrf-v{{ vlan.vlan_id.value }} type mac-vrf
set / network-instance macvrf-v{{ vlan.vlan_id.value }} admin-state enable
set / network-instance macvrf-v{{ vlan.vlan_id.value }} description macvrf-v{{ vlan.vlan_id.value }}
set / network-instance macvrf-v{{ vlan.vlan_id.value }} interface irb0.{{ irb_idx }}
set / network-instance macvrf-v{{ vlan.vlan_id.value }} vxlan-interface vxlan0.{{ vlan.evi.value }}
set / network-instance macvrf-v{{ vlan.vlan_id.value }} protocols bgp-evpn bgp-instance 1 vxlan-interface vxlan0.{{ vlan.evi.value }}
set / network-instance macvrf-v{{ vlan.vlan_id.value }} protocols bgp-evpn bgp-instance 1 evi {{ vlan.evi.value }}
set / network-instance macvrf-v{{ vlan.vlan_id.value }} protocols bgp-evpn bgp-instance 1 ecmp 8
set / network-instance macvrf-v{{ vlan.vlan_id.value }} protocols bgp-evpn bgp-instance 1 routes bridge-table mac-ip advertise-arp-nd-only-with-mac-table-entry true
set / network-instance macvrf-v{{ vlan.vlan_id.value }} protocols bgp-vpn bgp-instance 1 route-target export-rt {{ vlan.route_target.value }}
set / network-instance macvrf-v{{ vlan.vlan_id.value }} protocols bgp-vpn bgp-instance 1 route-target import-rt {{ vlan.route_target.value }}
set / network-instance macvrf-v{{ vlan.vlan_id.value }} bridge-table mac-learning admin-state enable
set / network-instance macvrf-v{{ vlan.vlan_id.value }} bridge-table mac-learning aging admin-state enable
set / network-instance macvrf-v{{ vlan.vlan_id.value }} bridge-table mac-learning aging age-time 300
set / network-instance macvrf-v{{ vlan.vlan_id.value }} bridge-table mac-duplication admin-state enable
set / network-instance macvrf-v{{ vlan.vlan_id.value }} bridge-table mac-duplication monitoring-window 3
set / network-instance macvrf-v{{ vlan.vlan_id.value }} bridge-table mac-duplication num-moves 5
set / network-instance macvrf-v{{ vlan.vlan_id.value }} bridge-table mac-duplication hold-down-time 9
set / network-instance macvrf-v{{ vlan.vlan_id.value }} bridge-table mac-duplication action stop-learning
{% endfor %}

# ── ip-vrf network instances (L3 EVPN, one per VRF) ──────────────────
{% for vrf in vrfs %}
set / network-instance {{ vrf.name.value }} type ip-vrf
set / network-instance {{ vrf.name.value }} admin-state enable
set / network-instance {{ vrf.name.value }} description {{ vrf.name.value }}
{# Bind every IRB subinterface that belongs to this VRF #}
{% for i in range(vlans | length) %}
{% set vlan = vlans[i] %}
{% if vlan.vrf.node.name.value == vrf.name.value %}
set / network-instance {{ vrf.name.value }} interface irb0.{{ i }}
{% endif %}
{% endfor %}
set / network-instance {{ vrf.name.value }} vxlan-interface vxlan0.{{ vrf.l3_evi.value }}
set / network-instance {{ vrf.name.value }} protocols bgp-evpn bgp-instance 1 vxlan-interface vxlan0.{{ vrf.l3_evi.value }}
set / network-instance {{ vrf.name.value }} protocols bgp-evpn bgp-instance 1 evi {{ vrf.l3_evi.value }}
set / network-instance {{ vrf.name.value }} protocols bgp-evpn bgp-instance 1 ecmp 8
set / network-instance {{ vrf.name.value }} protocols bgp-evpn bgp-instance 1 routes route-table mac-ip advertise-gateway-mac true
set / network-instance {{ vrf.name.value }} protocols bgp-vpn bgp-instance 1 route-target export-rt {{ vrf.route_target.value }}
set / network-instance {{ vrf.name.value }} protocols bgp-vpn bgp-instance 1 route-target import-rt {{ vrf.route_target.value }}
{% endfor %}

{% endif %}{# end leaf guard #}
